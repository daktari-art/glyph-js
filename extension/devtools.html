<!DOCTYPE html>
<html>
<head>
    <title>Glyph.js</title>
    <style>
        :root {
            --primary: #4a6cf7;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #0f172a;
            color: var(--light);
            padding: 0;
            margin: 0;
        }
        
        .container {
            padding: 15px;
            max-height: 100vh;
            overflow-y: auto;
        }
        
        .header {
            background: var(--dark);
            padding: 15px;
            border-bottom: 1px solid #334155;
            margin: -15px -15px 15px -15px;
        }
        
        h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
            background: linear-gradient(90deg, var(--primary), var(--success));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }
        
        .controls {
            display: flex;
            gap: 8px;
            margin: 15px 0;
        }
        
        button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-card {
            background: var(--dark);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: var(--gray);
            margin-top: 2px;
        }
        
        .execution-list {
            margin-top: 15px;
        }
        
        .execution-item {
            background: var(--dark);
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
            font-size: 0.8rem;
        }
        
        .execution-item.error {
            border-left-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .execution-item.success {
            border-left-color: var(--success);
        }
        
        .execution-item.warning {
            border-left-color: var(--warning);
        }
        
        .execution-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .execution-type {
            font-weight: bold;
        }
        
        .execution-time {
            color: var(--gray);
            font-size: 0.7rem;
        }
        
        .execution-data {
            color: var(--gray);
            font-size: 0.7rem;
            word-break: break-all;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }
        
        .framework-section {
            background: var(--dark);
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .framework-title {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Glyph.js</h1>
            <div class="status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Tracing active</span>
            </div>
        </div>
        
        <div class="controls">
            <button id="clearBtn">Clear Traces</button>
            <button id="exportBtn">Export</button>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalSteps">0</div>
                <div class="stat-label">Total Steps</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="errorCount">0</div>
                <div class="stat-label">Errors</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="warningCount">0</div>
                <div class="stat-label">Warnings</div>
            </div>
        </div>
        
        <div id="frameworkInfo"></div>
        
        <div class="execution-list" id="executionList">
            <div class="empty-state">
                Waiting for execution data...
                <br><small>Interact with the page to see traces</small>
            </div>
        </div>
    </div>

    <script>
        class GlyphPanel {
            constructor() {
                this.traceData = [];
                this.stats = {
                    totalSteps: 0,
                    errorCount: 0,
                    warningCount: 0
                };
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.setupMessageHandlers();
                this.updateUI();
            }
            
            setupEventListeners() {
                document.getElementById('clearBtn').addEventListener('click', () => {
                    this.traceData = [];
                    this.updateStats();
                    this.updateExecutionList();
                });
                
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportData();
                });
            }
            
            setupMessageHandlers() {
                window.addEventListener('message', (event) => {
                    if (event.data.type?.startsWith('GLYPH_')) {
                        this.handleMessage(event.data);
                    }
                });
            }
            
            handleMessage(message) {
                switch (message.type) {
                    case 'GLYPH_TRACE_UPDATE':
                        this.handleTraceUpdate(message.data);
                        break;
                    case 'GLYPH_INITIAL_STATE':
                        this.handleInitialState(message.data);
                        break;
                    case 'GLYPH_TRACING_STARTED':
                        this.updateStatus('Tracing active', 'var(--success)');
                        break;
                    case 'GLYPH_TRACING_ERROR':
                        this.updateStatus('Tracing error', 'var(--error)');
                        break;
                }
            }
            
            handleTraceUpdate(data) {
                this.traceData.unshift(data);
                
                if (this.traceData.length > 50) {
                    this.traceData = this.traceData.slice(0, 50);
                }
                
                this.updateStats();
                this.updateExecutionList();
                
                if (data.type.includes('React')) {
                    this.updateFrameworkInfo('react', data);
                } else if (data.type.includes('Vue')) {
                    this.updateFrameworkInfo('vue', data);
                } else if (data.type.includes('Angular')) {
                    this.updateFrameworkInfo('angular', data);
                }
            }
            
            handleInitialState(data) {
                this.traceData = data.traceData || [];
                this.updateStats();
                this.updateExecutionList();
            }
            
            updateStats() {
                this.stats.totalSteps = this.traceData.length;
                this.stats.errorCount = this.traceData.filter(t => t.status === 'error').length;
                this.stats.warningCount = this.traceData.filter(t => t.type.includes('Warning')).length;
                
                document.getElementById('totalSteps').textContent = this.stats.totalSteps;
                document.getElementById('errorCount').textContent = this.stats.errorCount;
                document.getElementById('warningCount').textContent = this.stats.warningCount;
            }
            
            updateExecutionList() {
                const container = document.getElementById('executionList');
                
                if (this.traceData.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            Waiting for execution data...
                            <br><small>Interact with the page to see traces</small>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = this.traceData.map(item => `
                    <div class="execution-item ${item.status === 'error' ? 'error' : item.status === 'success' ? 'success' : ''}">
                        <div class="execution-header">
                            <span class="execution-type">${item.type}</span>
                            <span class="execution-time">${this.formatTime(item.timestamp)}</span>
                        </div>
                        <div class="execution-data">
                            ${this.formatData(item.data)}
                        </div>
                    </div>
                `).join('');
            }
            
            updateFrameworkInfo(framework, data) {
                let frameworkInfo = document.getElementById('frameworkInfo');
                if (!frameworkInfo) {
                    frameworkInfo = document.createElement('div');
                    frameworkInfo.id = 'frameworkInfo';
                    document.querySelector('.stats').after(frameworkInfo);
                }
                
                const icon = framework === 'react' ? '⚛️' : framework === 'vue' ? '🟢' : '🅰️';
                const name = framework === 'react' ? 'React' : framework === 'vue' ? 'Vue.js' : 'Angular';
                
                frameworkInfo.innerHTML = `
                    <div class="framework-section">
                        <div class="framework-title">
                            ${icon} ${name} Detected
                        </div>
                        <div class="execution-data">
                            ${data.data?.component || data.data?.version || 'Active'}
                        </div>
                    </div>
                `;
            }
            
            updateStatus(text, color) {
                document.getElementById('statusText').textContent = text;
                document.getElementById('statusDot').style.background = color;
            }
            
            formatTime(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;
                
                if (diff < 1000) return 'now';
                if (diff < 60000) return `${Math.floor(diff / 1000)}s ago`;
                return new Date(timestamp).toLocaleTimeString();
            }
            
            formatData(data) {
                if (!data) return '';
                
                return Object.entries(data)
                    .map(([key, value]) => {
                        if (key === 'stack') return '';
                        if (typeof value === 'object') return `${key}: object`;
                        return `${key}: ${value}`;
                    })
                    .filter(Boolean)
                    .join(' | ');
            }
            
            exportData() {
                const exportData = {
                    version: '1.0',
                    exportedAt: new Date().toISOString(),
                    traces: this.traceData,
                    stats: this.stats
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `glyph-trace-${Date.now()}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
            }
            
            updateUI() {
                this.updateStats();
                this.updateExecutionList();
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            new GlyphPanel();
        });
    </script>
</body>
</html>
